# CourseInfo 工具集成测试指南

## 概述

本文档说明如何测试新集成的 courseInfo 工具，该工具通过 MCP (Model Context Protocol) 连接到 JustinCourse 知识库。

## 集成内容

### 新增文件

1. **`lib/ai/mcp-client.ts`** - MCP 客户端管理器（备用实现）
   - 处理 SSE 连接和会话管理
   - 实现重连逻辑和错误处理
   - 提供工具调用接口

2. **`lib/ai/tools/course-info-simple.ts`** - CourseInfo 工具（当前使用）
   - 直接调用 REST API，避免复杂的 MCP 连接
   - 搜索 JustinCourse 知识库
   - 支持 WordPress 文章和 FAQ 搜索
   - 更稳定的错误处理

### 修改文件

1. **`app/(chat)/api/chat/route.ts`** - 聊天 API 路由
   - 添加 courseInfoSimple 工具导入
   - 更新 tools 对象和 experimental_activeTools 数组
   - 支持更多模型类型（large, small, reasoning）

2. **`lib/ai/prompts.ts`** - 系统提示
   - 更新系统提示，告知 AI 可以使用课程信息工具

3. **`package.json`** - 依赖包
   - 添加 `eventsource` 和 `@types/eventsource` 依赖

## 测试方法

### 1. 功能测试

启动开发服务器：
```bash
pnpm dev
```

在聊天界面中测试以下查询：

#### 课程相关查询
- "告诉我 JustinCourse 有哪些课程？"
- "web course 的内容是什么？"
- "如何报名课程？"
- "课程费用是多少？"

#### 技术教程查询
- "如何部署 Cloudflare Workers？"
- "Next.js 教程有哪些？"
- "TypeScript 学习资料"
- "MCP 服务器怎么设置？"

#### FAQ 查询
- "课程学习要求"
- "付费方式"
- "技术支持"

### 2. 搜索类型测试

使用不同的搜索类型测试工具功能：

#### Comprehensive (默认)
```
测试查询："cloudflare workers 课程"
预期：同时搜索课程内容和 FAQ，返回全面信息
```

#### Courses
```
测试查询："web 开发课程"
预期：重点返回课程详情和报名信息
```

#### Tutorials
```
测试查询："next.js 部署教程"
预期：重点返回技术教程和实战内容
```

#### FAQ
```
测试查询："报名流程"
预期：重点返回常见问题快速答案
```

### 3. 错误处理测试

#### 网络连接测试
- 断开网络连接，测试错误处理
- 预期：显示友好的错误信息

#### 无结果查询测试
- 搜索不存在的内容："xyz123课程"
- 预期：显示帮助信息和官方链接

#### 超时测试
- 如果 MCP 服务器响应慢
- 预期：合理的超时处理和重试机制

### 4. 会话管理测试

#### 长时间使用
- 持续使用聊天功能 5+ 分钟
- 预期：MCP 连接保持稳定

#### 重连测试
- 模拟网络中断后恢复
- 预期：自动重连，功能正常

## 预期行为

### 成功场景
1. **快速响应** - 工具调用应在 5-10 秒内完成
2. **丰富内容** - 返回格式化的搜索结果，包含链接和官方资源
3. **智能搜索** - 根据查询内容自动选择最佳搜索策略
4. **错误恢复** - 网络问题后能自动重连

### 错误处理
1. **友好错误信息** - 显示用户友好的错误提示
2. **备选方案** - 提供官方网站链接作为备选
3. **自动重试** - 网络问题时自动重试连接

## 调试

### 日志检查
在开发者控制台中检查以下日志：
- MCP 连接状态
- 工具调用请求和响应
- 错误和重连尝试

### 关键日志示例
```
MCP SSE connected for session: mcp-1634567890-abc123
Received MCP notification: tools/call
CourseInfo tool error: 知识库服务暂时不可用，请稍后重试
```

### 常见问题

#### 工具不被调用
- 检查模型是否支持工具调用（需要 chat-model-reasoning 模型）
- 检查系统提示是否正确更新

#### 连接失败
- 检查网络连接
- 验证 MCP 服务器地址：`https://hono-mcp-demo.justincourse.site/sse`

#### 类型错误
- 运行 `npx tsc --noEmit --skipLibCheck` 检查类型问题

## 监控和维护

### 性能监控
- 监控工具调用响应时间
- 检查 MCP 连接稳定性
- 观察错误率和重连频率

### 定期维护
- 更新 MCP 服务器地址（如果变更）
- 检查依赖包更新
- 优化搜索参数和错误处理

## 后续优化

1. **缓存机制** - 实现搜索结果缓存
2. **预加载** - 预加载常用搜索结果
3. **智能推荐** - 基于用户查询历史提供智能推荐
4. **多语言支持** - 改进中英文混合搜索